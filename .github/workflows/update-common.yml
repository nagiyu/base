name: Update Common

on:
  push:
    branches:
      - master

jobs:
  update-common:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: AWS CLI install
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install --update
          aws --version

      - name: AWS set Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Update Common to Target Repositories
        run: |
          IFS=';' read -ra TARGETS <<< "${{ vars.UPDATE_COMMON_TARGETS }}"
          for TARGET in "${TARGETS[@]}"; do
            REPO_URL=$(echo "$TARGET" | cut -d',' -f1)
            BRANCH=$(echo "$TARGET" | cut -d',' -f2)
            REPO_NAME=$(basename -s .git "$REPO_URL")
            echo "Processing $REPO_URL ($BRANCH)"

            git clone "$REPO_URL"
            cd "$REPO_NAME"

            git config --local user.name "${{ env.GITHUB_USERNAME }}"
            git config --local user.email "${{ env.GITHUB_EMAIL }}"

            git checkout "$BRANCH"

            BRANCH_NAME="update-common-$(date +%Y%m%d-%H%M%S)"
            git checkout -b "$BRANCH_NAME"

            git remote add base https://github.com/nagiyu/nagiyu-template.git || true
            git fetch base

            git merge -X theirs base/master --allow-unrelated-histories || true

            if [ -f .git/MERGE_HEAD ]; then
              # Remove delete conflicts (DU)
              git status --porcelain | grep '^DU ' | awk '{print $2}' | while read file; do
                git rm -f "$file"
              done

              # Handle conflict files
              git diff --name-only --diff-filter=U | while read file; do
                if git show ":3:$file" > /dev/null 2>&1; then
                  git checkout --theirs "$file"
                  git add "$file"
                else
                  git rm -f "$file"
                fi
              done
            fi

            git remote set-url origin "https://x-access-token:${{ env.GITHUB_PERSONAL_ACCESS_TOKEN }}@${REPO_URL#https://}"

            if [ -n "$(git status --porcelain)" ]; then
              # Remove unwanted files before commit
              git restore .github/workflows/update-common.yml README.md

              git add .
              git commit -m "Update common files"
              git push origin "$BRANCH_NAME"

              export GH_TOKEN="${{ env.GITHUB_PERSONAL_ACCESS_TOKEN }}"
              gh pr create --title "Update common files" --body "This PR updates common files." --base "$BRANCH" --head "$BRANCH_NAME" --draft
            else
              echo "No changes to commit for $REPO_URL"
            fi

            cd ..
            rm -rf "$REPO_NAME"
          done
